<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Premier League Stats</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f8f9fa; padding: 20px; }
        .card { margin-bottom: 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .table thead { background-color: #37003c; color: white; }
        .match-card { border-left: 4px solid #00ff87; }
        .badge { background-color: #00ff87; color: #37003c; }
        .score { font-weight: 500; color: #37003c; }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="text-center mb-4" style="color: #37003c;">Premier League Stats</h1>
        
        <!-- League Table -->
        <div class="card">
            <div class="card-header">
                <h3>Current Standings</h3>
            </div>
            <div class="card-body table-responsive">
                <table class="table table-hover" id="leagueTable">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>Team</th>
                            <th>MP</th>
                            <th>W</th>
                            <th>D</th>
                            <th>L</th>
                            <th>GF</th>
                            <th>GA</th>
                            <th>GD</th>
                            <th>Pts</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody"></tbody>
                </table>
            </div>
        </div>

        <!-- Results & Fixtures -->
        <div class="row">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h3>Recent Results</h3>
                    </div>
                    <div class="card-body" id="recentResults"></div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h3>Upcoming Fixtures</h3>
                    </div>
                    <div class="card-body" id="upcomingFixtures"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        async function fetchUnderstatData() {
            try {
                const proxyUrl = 'https://api.allorigins.win/get?url=' + 
                    encodeURIComponent('https://understat.com/league/EPL');
                const response = await fetch(proxyUrl);
                const data = await response.json();
                return new DOMParser().parseFromString(data.contents, "text/html");
            } catch (error) {
                console.error('Error fetching data:', error);
                return null;
            }
        }

        function extractJSONData(html, variableName) {
            const scriptContent = Array.from(html.querySelectorAll('script'))
                .find(script => script.textContent.includes(variableName))?.textContent;
            
            if (!scriptContent) return null;
            
            const jsonString = scriptContent.match(
                new RegExp(`${variableName}\\s*=\\s*JSON\\.parse\\('(.*?)'\\)`)
            )?.[1];
            
            return jsonString ? JSON.parse(JSON.parse(`"${jsonString}"`)) : null;
        }

        async function updateLeagueTable() {
            const html = await fetchUnderstatData();
            if (!html) return;

            const teamsData = extractJSONData(html, 'teamsData');
            if (!teamsData) return;

            const tableBody = document.getElementById('tableBody');
            tableBody.innerHTML = '';

            Object.values(teamsData).forEach((team, index) => {
                const row = `
                    <tr>
                        <td>${index + 1}</td>
                        <td>${team.title}</td>
                        <td>${team.games}</td>
                        <td>${team.wins}</td>
                        <td>${team.draws}</td>
                        <td>${team.loses}</td>
                        <td>${team.scored}</td>
                        <td>${team.missed}</td>
                        <td>${team.goals_diff}</td>
                        <td><strong>${team.pts}</strong></td>
                    </tr>
                `;
                tableBody.innerHTML += row;
            });
        }

        async function updateMatches() {
            const html = await fetchUnderstatData();
            if (!html) return;

            const matchesData = extractJSONData(html, 'datesData');
            if (!matchesData) return;

            const now = new Date();
            const recentResults = document.getElementById('recentResults');
            const upcomingFixtures = document.getElementById('upcomingFixtures');
            recentResults.innerHTML = '';
            upcomingFixtures.innerHTML = '';

            matchesData.forEach(match => {
                const matchDate = new Date(match.time);
                const isPast = matchDate < now;
                
                const matchElement = `
                    <div class="match-card mb-2 p-3">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <small>${matchDate.toLocaleDateString()}</small>
                                <div class="fw-bold">
                                    ${match.h} vs ${match.a}
                                </div>
                            </div>
                            ${isPast ? `
                                <div class="score">
                                    ${match.goals.h} - ${match.goals.a}
                                </div>
                            ` : '<span class="badge">VS</span>'}
                        </div>
                    </div>
                `;

                if (isPast) {
                    recentResults.innerHTML += matchElement;
                } else {
                    upcomingFixtures.innerHTML += matchElement;
                }
            });
        }

        async function updateAllData() {
            await updateLeagueTable();
            await updateMatches();
        }

        // Initial load
        updateAllData();
        // Update every 15 minutes
        setInterval(updateAllData, 900000);
    </script>
</body>
</html>
